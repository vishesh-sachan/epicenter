# AI Chat Tab in Tab Manager Extension
**Status**: Superseded
**Superseded by**: `specs/20260223T195800-background-ai-stream-on-switch.md` — The original single-instance design, hardcoded model lists, and single-conversation scope have been replaced by multi-conversation support with per-conversation `createChat()` instances, TanStack AI package model imports, and background streaming.

## TL;DR

> **Quick Summary**: Add a third "AI" tab to the tab manager Chrome extension sidepanel that lets users chat with LLMs via TanStack AI Svelte, using the existing `packages/server` backend with server-owned API keys.
>
> **Deliverables**:
>
> - Server: env var API key support in `createAIPlugin()` (backward-compatible)
> - Extension: new "AI" tab with chat interface using `@epicenter/ui/chat` components
> - Extension: `@tanstack/ai-svelte` integration with SSE streaming
> - Extension: Y.Doc persistence for chat messages (unidirectional: write on send/complete, read on open)
> - Extension: configurable server URL setting
> - Extension: provider dropdown + curated model dropdown per provider
>
> **Estimated Effort**: Medium
> **Parallel Execution**: YES - 3 waves
> **Critical Path**: Task 2 (deps) → Task 5 (state) → Task 6 (UI + wiring)

---

## Context

### Original Request

Add an AI chat tab to the tab manager Chrome extension where users can chat with LLMs. Uses `packages/server` as the backend with TanStack AI adapters.

### Interview Summary

**Key Discussions**:

- **API key architecture**: Server owns keys via env vars — extension never handles secrets
- **Provider/model selection**: Provider dropdown + curated model dropdown per provider at bottom of chat
- **Chat persistence**: Y.Doc — messages persist and sync across devices, using unidirectional flow (write to Y.Doc on send/complete, read from Y.Doc on panel open)
- **UI scope**: Minimal functional — basic bubbles, input, loading indicator
- **Server URL**: Configurable via chrome.storage.local (default: localhost:3913)
- **Conversation model**: Multi-conversation ready (conversationId on each message), single-conversation UI for v1

**Research Findings**:

- `@tanstack/ai-svelte` v0.5.3 exists with `createChat()` + `fetchServerSentEvents()` (Svelte 5 runes)
- `@epicenter/ui/chat` already has Chat.List, Chat.Bubble, Chat.BubbleMessage, LoadingDots components
- Server's `POST /ai/chat` SSE endpoint is already implemented and tested
- Server currently requires `x-provider-api-key` header per-request (needs env var fallback)
- `start.ts` already uses `createServer()` with AI endpoint mounted — no changes needed
- Y.Doc tables natively support nested objects and arrays (proven by `mutedInfo` field in tabs table) — no JSON serialization needed for `parts`
- TanStack AI `UIMessage` format: `{ id, role, parts: MessagePart[], createdAt? }` where `MessagePart` is a union of `TextPart | ToolCallPart | ToolResultPart | ThinkingPart`
- TanStack AI `createChat` supports `initialMessages` for seeding from database, and `setMessages()` for runtime updates

### TanStack AI Message Format

```typescript
// UIMessage — what createChat() manages internally
interface UIMessage {
	id: string;
	role: 'system' | 'user' | 'assistant';
	parts: Array<MessagePart>;
	createdAt?: Date;
}

// MessagePart — discriminated union
type MessagePart = TextPart | ToolCallPart | ToolResultPart | ThinkingPart;

interface TextPart {
	type: 'text';
	content: string;
	metadata?: unknown;
}
interface ThinkingPart {
	type: 'thinking';
	content: string;
}
interface ToolCallPart {
	type: 'tool-call';
	id: string;
	name: string;
	arguments: string;
	state: string;
}
interface ToolResultPart {
	type: 'tool-result';
	toolCallId: string;
	content: string;
	state: string;
}
```

### Metis Review

**Identified Gaps** (addressed):

- **TanStack AI message format mismatch**: Server's Elysia uses strict body validation; TanStack AI may send extra fields → Elysia strips unknown properties by default, not a blocker
- **Chrome extension CSP**: Sidepanel should be able to fetch localhost, but `host_permissions: ['<all_urls>']` already covers this → Verified, low risk
- **Message format**: TanStack AI uses `message.parts[0].content`, not `message.content` → Plan stores parts array directly in Y.Doc
- **Y.Doc schema addition**: New tables in existing Y.Doc are handled gracefully by `@epicenter/hq` (new Y.Map keys appear as needed)
- **Empty state UI**: Need to handle no-messages state → Plan includes empty state in chat component task
- **Error state UX**: Need to handle server errors, unreachable → Plan includes inline error display

---

## Work Objectives

### Core Objective

Enable AI chat directly within the tab manager Chrome extension sidepanel, connecting to the existing server backend via SSE streaming.

### Concrete Deliverables

- `packages/server/src/ai/plugin.ts` — modified to support env var API keys
- `packages/server/src/ai/adapters.ts` — modified with env var resolution
- `apps/tab-manager/src/lib/state/ai-chat-state.svelte.ts` — new state module
- `apps/tab-manager/src/lib/state/settings.ts` — new settings module for server URL
- `apps/tab-manager/src/lib/components/AiChat.svelte` — new chat component
- `apps/tab-manager/src/entrypoints/sidepanel/App.svelte` — modified with third tab
- `apps/tab-manager/src/lib/workspace.ts` — modified with chatMessages table

### Definition of Done

- [ ] `bun run typecheck` in `apps/tab-manager/` passes
- [ ] `bun run build` in `apps/tab-manager/` succeeds
- [ ] `bun test` in `packages/server/` passes (including new tests)
- [ ] AI tab visible in extension sidepanel with send/receive working
- [ ] Server starts with AI endpoint via `bun run start` in `packages/server/`

### Must Have

- Third "AI" tab in sidepanel with chat interface
- SSE streaming via `@tanstack/ai-svelte`
- Server env var API key support (backward-compatible with per-request header)
- Provider dropdown (OpenAI, Anthropic, Gemini, Ollama, Grok)
- Model dropdown with curated per-provider options
- Loading indicator during streaming
- Error display when server unreachable or provider errors
- Chat messages persisted in Y.Doc with `conversationId` field (future-proofed for multi-conversation)

### Must NOT Have (Guardrails)

- NO changes to `background.ts` — AI chat is sidepanel-only
- NO markdown rendering (plain text only in v1)
- NO system prompt configuration
- NO conversation management UI (new chat, history, rename) — single conversation for v1
- NO new Chrome extension permissions
- NO modifications to `@epicenter/ui/chat` components (use as-is)
- NO model temperature/options controls
- NO streaming token count display
- NO client-side API key handling (keys are server-owned)

---

## Verification Strategy

> **ZERO HUMAN INTERVENTION** — ALL verification is agent-executed. No exceptions.

### Test Decision

- **Infrastructure exists**: YES (bun test, existing `plugin.test.ts`)
- **Automated tests**: Tests-after
- **Framework**: bun test
- **If TDD**: N/A

### QA Policy

Every task MUST include agent-executed QA scenarios.
Evidence saved to `.sisyphus/evidence/task-{N}-{scenario-slug}.{ext}`.

- **Server API**: Use Bash (curl) — send requests, assert status + response fields
- **Extension build**: Use Bash (bun) — typecheck, build commands

---

## Execution Strategy

### Parallel Execution Waves

```
Wave 1 (Start Immediately — no dependencies, 3 parallel):
├── Task 1: Server env var API key fallback [quick]
├── Task 2: Extension add @tanstack/ai-svelte dependencies [quick]
└── Task 3: Extension server URL settings module [quick]

Wave 2 (After Wave 1 — schema + state, 2 parallel):
├── Task 4: Extension workspace schema (chatMessages table) [quick]
└── Task 5: Extension AI chat state module (depends: 2, 3, 4) [unspecified-high]

Wave 3 (After Wave 2 — UI + wiring):
└── Task 6: Extension AI chat component + App.svelte wiring [visual-engineering]

Wave 4 (After Wave 3 — tests + verification, 2 parallel):
├── Task 7: Server tests for env var API key fallback [quick]
└── Task 8: Extension build + typecheck verification [quick]

Wave FINAL (After ALL tasks — 2 parallel):
├── Task F1: Plan compliance audit (oracle)
└── Task F2: Code quality review (unspecified-high)

Critical Path: Task 2 → Task 5 → Task 6 → Task 8 → F1-F2
Parallel Speedup: ~35% faster than sequential
Max Concurrent: 3 (Wave 1)
```

### Dependency Matrix

| Task | Depends On | Blocks | Wave |
| ---- | ---------- | ------ | ---- |
| 1    | —          | 5, 7   | 1    |
| 2    | —          | 5      | 1    |
| 3    | —          | 5      | 1    |
| 4    | —          | 5      | 2    |
| 5    | 1, 2, 3, 4 | 6      | 2    |
| 6    | 5          | 8      | 3    |
| 7    | 1          | F1-F2  | 4    |
| 8    | 6          | F1-F2  | 4    |

### Agent Dispatch Summary

- **Wave 1**: **3** — T1 → `quick`, T2 → `quick`, T3 → `quick`
- **Wave 2**: **2** — T4 → `quick`, T5 → `unspecified-high`
- **Wave 3**: **1** — T6 → `visual-engineering`
- **Wave 4**: **2** — T7 → `quick`, T8 → `quick`
- **FINAL**: **2** — F1 → `oracle`, F2 → `unspecified-high`

---

## TODOs

- [ ] 1. Server: Add env var API key fallback to `createAIPlugin()`

  **What to do**:
  - In `packages/server/src/ai/adapters.ts`, add an env var name mapping constant:
    ```typescript
    const PROVIDER_ENV_VARS: Record<SupportedProvider, string> = {
    	openai: 'OPENAI_API_KEY',
    	anthropic: 'ANTHROPIC_API_KEY',
    	gemini: 'GEMINI_API_KEY',
    	grok: 'GROK_API_KEY',
    	ollama: '', // no key needed
    };
    ```
  - Add a `resolveApiKey(provider, headerKey?)` function that: (1) returns `headerKey` if provided (backward compat), (2) falls back to `process.env[PROVIDER_ENV_VARS[provider]]`, (3) returns `undefined` if neither exists.
  - In `packages/server/src/ai/plugin.ts`, replace the direct `headers['x-provider-api-key']` usage with `resolveApiKey(provider, headers['x-provider-api-key'])`. Update the 401 error message to: `'Missing API key: set x-provider-api-key header or configure ${envVarName} environment variable'`.
  - Export the env var mapping and `resolveApiKey` from `adapters.ts`.

  **Must NOT do**:
  - Do NOT remove per-request header support (backward compatibility)
  - Do NOT change Ollama behavior (still no key needed)
  - Do NOT add env var reading at module level (read at request time so env can change)

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: [`typescript`, `error-handling`]

  **Parallelization**:
  - **Can Run In Parallel**: YES
  - **Parallel Group**: Wave 1 (with Tasks 2, 3)
  - **Blocks**: Tasks 5, 7
  - **Blocked By**: None

  **References**:
  - `packages/server/src/ai/adapters.ts` — Full file. Contains `SUPPORTED_PROVIDERS`, `ADAPTER_FACTORIES`, `createAdapter()`, `isSupportedProvider()`.
  - `packages/server/src/ai/plugin.ts:47-67` — The `createAIPlugin()` handler where `apiKey` is extracted from headers and validated.
  - `packages/server/src/ai/plugin.test.ts` — Existing tests. The 401 test will need updating since the error message changes.

  **Acceptance Criteria**:

  ```
  Scenario: Env var API key works when header is absent
    Tool: Bash (curl)
    Preconditions: Server running with OPENAI_API_KEY=sk-test-invalid-key env var
    Steps:
      1. Start server: OPENAI_API_KEY=sk-test-key bun packages/server/src/start.ts &
      2. curl POST to /ai/chat with provider=openai, no x-provider-api-key header
      3. Assert: HTTP status is NOT 401
    Expected Result: Status 200 (streaming) or 502 (provider error from invalid key) — NOT 401

  Scenario: Header key overrides env var key (backward compat)
    Tool: Bash (curl)
    Preconditions: Server running with OPENAI_API_KEY=sk-env-key
    Steps:
      1. curl POST with x-provider-api-key: sk-header-key header
      2. Assert: Request uses header key
    Expected Result: HTTP 502 (provider error — tried to use header key)

  Scenario: Missing key returns 401 with helpful message
    Tool: Bash (curl)
    Preconditions: Server running with NO env vars set
    Steps:
      1. curl POST with no header, no env var
      2. Assert: Response contains "OPENAI_API_KEY" in error message
    Expected Result: HTTP 401 with error message mentioning both header and env var options

  Scenario: Ollama still works without any key
    Tool: Bash (curl)
    Preconditions: Server running with NO env vars
    Steps:
      1. curl POST with provider=ollama, no header
      2. Assert: NOT 401
    Expected Result: NOT 401 (likely 502 if no Ollama running, but not auth error)
  ```

  **Commit**: YES
  - Message: `feat(server): add env var API key fallback for AI providers`
  - Files: `packages/server/src/ai/adapters.ts`, `packages/server/src/ai/plugin.ts`

- [ ] 2. Extension: Add `@tanstack/ai-svelte` and `@tanstack/ai` dependencies

  **What to do**:
  - Run `bun add @tanstack/ai-svelte @tanstack/ai` in `apps/tab-manager/`
  - Verify the packages resolve correctly
  - Run `bun run build` and `bun run typecheck` to verify no conflicts

  **Must NOT do**:
  - Do NOT add any other dependencies
  - Do NOT modify any source files

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: [`monorepo`]

  **Parallelization**: Wave 1 (with Tasks 1, 3). Blocks Task 5.

  **References**:
  - `apps/tab-manager/package.json` — Add to `dependencies` (not devDependencies)

  **Acceptance Criteria**:

  ```
  Scenario: Dependencies install and build succeeds
    Steps: bun install, bun run build, bun run typecheck in apps/tab-manager
    Expected Result: All exit 0
  ```

  **Commit**: YES — `build(tab-manager): add @tanstack/ai-svelte dependencies`

- [ ] 3. Extension: Create server URL settings module

  **What to do**:
  - Create `apps/tab-manager/src/lib/state/settings.ts` using `@wxt-dev/storage` pattern
  - Define `serverUrl` storage item: `storage.defineItem<string>('local:serverUrl', { fallback: 'http://127.0.0.1:3913' })`
  - Export `getServerUrl()` and `setServerUrl(url)` async functions
  - Follow pattern from `apps/tab-manager/src/lib/device/device-id.ts`

  **Must NOT do**:
  - Do NOT create a settings UI (future work)
  - Do NOT make the WebSocket sync URL configurable
  - Do NOT validate the URL format

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: [`typescript`]

  **Parallelization**: Wave 1 (with Tasks 1, 2). Blocks Task 5.

  **References**:
  - `apps/tab-manager/src/lib/device/device-id.ts` — `storage.defineItem()` pattern

  **Acceptance Criteria**:

  ```
  Scenario: Settings module exports correct API
    Steps: bun run typecheck, verify both functions exported
    Expected Result: typecheck passes
  ```

  **Commit**: YES — `feat(tab-manager): add configurable server URL setting`

- [ ] 4. Extension: Add `chatMessages` table to workspace schema

  **What to do**:
  - In `apps/tab-manager/src/lib/workspace.ts`, add a `chatMessages` table after `savedTabs`:
    ```typescript
    chatMessages: defineTable(
      type({
        id: 'string',                  // TanStack AI message ID or nanoid
        conversationId: 'string',       // Groups messages into threads
        role: "'user' | 'assistant'",   // Message sender
        parts: 'unknown[]',             // TanStack AI MessagePart[] — stored as native array
        createdAt: 'number',            // ms since epoch
        _v: '1',
      }),
    ),
    ```
  - Add type export: `export type ChatMessage = InferTableRow<Tables['chatMessages']>;`
  - The `parts` field stores TanStack AI's `MessagePart[]` directly as a native array in Y.Doc — no JSON serialization needed. Y.Doc LWW storage handles objects and arrays natively (proven by `mutedInfo` object in tabs table).
  - `conversationId` included now for future multi-conversation support. v1 UI uses a single default conversation.

  **Must NOT do**:
  - Do NOT add a `conversations` table
  - Do NOT add `systemPrompt` or `modelOptions` fields
  - Do NOT add per-message `provider` or `model` fields (those are preferences, not per-message data)
  - Do NOT modify any existing table definitions

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: [`typescript`, `static-workspace-api`]

  **Parallelization**: Wave 2 (with Task 5). Blocks Task 5.

  **References**:
  - `apps/tab-manager/src/lib/workspace.ts:324-337` — `savedTabs` table. Follow this pattern.
  - `apps/tab-manager/src/lib/workspace.ts:344-350` — Type exports section.
  - `apps/tab-manager/src/lib/workspace.ts:243` — `mutedInfo` field. Proof nested objects work.

  **Acceptance Criteria**:

  ```
  Scenario: Schema typechecks and type exported
    Steps: bun run typecheck, verify ChatMessage export exists
    Expected Result: 0 errors, export found
  ```

  **Commit**: YES — `feat(tab-manager): add chatMessages table to workspace schema`

- [ ] 5. Extension: Create AI chat state module

  **What to do**:
  - Create `apps/tab-manager/src/lib/state/ai-chat-state.svelte.ts`
  - Follow `createXxxState()` singleton pattern from `saved-tab-state.svelte.ts`
  - Use `createChat` and `fetchServerSentEvents` from `@tanstack/ai-svelte`
  - Use `getServerUrl` from `$lib/state/settings`

  **The state module must**:
  1. Create `$state` fields for `provider` (default: `'openai'`) and `model` (default: `'gpt-4o-mini'`)
  2. Create a static `PROVIDER_MODELS` map with curated models per provider:
     ```typescript
     const PROVIDER_MODELS: Record<string, string[]> = {
     	openai: ['gpt-4o', 'gpt-4o-mini', 'o3-mini'],
     	anthropic: ['claude-sonnet-4-20250514', 'claude-haiku-4-20250414'],
     	gemini: ['gemini-2.0-flash', 'gemini-2.5-pro'],
     	ollama: ['llama3', 'mistral', 'codellama'],
     	grok: ['grok-2', 'grok-2-mini'],
     };
     ```
  3. Create chat connection: `createChat({ connection: fetchServerSentEvents({ url: serverUrl + '/ai/chat' }), body: { provider, model } })`
  4. Handle `body` dynamically — read current provider/model at send time
  5. Generate default `conversationId` (nanoid) on init
  6. **Unidirectional Y.Doc persistence** (NOT bidirectional sync):
     - **On send**: Write user message to `popupWorkspace.tables.chatMessages` immediately before server request
     - **On stream complete**: Write final assistant message to `popupWorkspace.tables.chatMessages`
     - **On panel open (init)**: Read existing messages from Y.Doc for active conversationId → seed via `initialMessages` or `setMessages()`
     - **Message format**: Store `parts` array directly (no JSON serialization). Write: `{ id, conversationId, role, parts: message.parts, createdAt: Date.now() }`. Read: reconstruct `UIMessage` from row.
     - Use Y.Doc observer only for remote change detection
  7. Expose: `messages`, `isLoading`, `error`, `sendMessage(content)`, `stop()`, `clear()`, `provider` (get/set), `model` (get/set), `availableProviders`, `modelsForProvider(provider)`, `conversationId`

  **Must NOT do**:
  - Do NOT implement bidirectional state sync
  - Do NOT add conversation management (switching, naming, history list)
  - Do NOT add system prompt support
  - Do NOT add model options (temperature, etc.)
  - Do NOT modify `workspace-popup.ts`

  **Recommended Agent Profile**:
  - **Category**: `unspecified-high`
  - **Skills**: [`svelte`, `typescript`, `factory-function-composition`, `yjs`]

  **Parallelization**: Wave 2 (needs Tasks 1-4). Blocks Task 6.

  **References**:
  - `apps/tab-manager/src/lib/state/saved-tab-state.svelte.ts` — THE reference pattern. Factory, $state, Y.Doc observer, CRUD, generateId.
  - `apps/tab-manager/src/lib/workspace-popup.ts` — `popupWorkspace` for Y.Doc access.
  - `apps/tab-manager/src/lib/workspace.ts` — `ChatMessage` type (Task 4).
  - `apps/tab-manager/src/lib/state/settings.ts` — `getServerUrl()` (Task 3).

  **Acceptance Criteria**:

  ```
  Scenario: State module typechecks and exports correct shape
    Steps: bun run typecheck, verify aiChatState exports all properties
    Expected Result: Typecheck passes, all exports present

  Scenario: Provider list includes all supported providers
    Steps: Verify openai, anthropic, gemini, ollama, grok in file
    Expected Result: All 5 present
  ```

  **Commit**: YES — `feat(tab-manager): add AI chat state module with TanStack AI + Y.Doc persistence`

- [ ] 6. Extension: Create AI chat component and wire into App.svelte

  **What to do**:

  **Part A — Create `AiChat.svelte`**:
  - Create `apps/tab-manager/src/lib/components/AiChat.svelte`
  - Import `aiChatState`, Chat components, Select, Textarea, Button, icons

  **Layout** (flex column, full height):

  ```
  ┌─────────────────────────┐
  │ [Empty state / Messages] │  ← Chat.List (flex-1, overflow-y-auto)
  ├─────────────────────────┤
  │ [Error banner]           │  ← Conditional
  ├─────────────────────────┤
  │ [Provider ▼] [Model ▼]  │  ← Select dropdowns
  │ [Textarea........][Send] │  ← Input area
  └─────────────────────────┘
  ```

  **Message rendering**:
  - `{#each aiChatState.messages as message (message.id)}`
  - `Chat.Bubble variant={role === 'user' ? 'sent' : 'received'}`
  - Render text parts: `message.parts.filter(p => p.type === 'text').map(p => p.content).join('')`
  - Loading dots bubble when `isLoading` and last message is from user

  **Provider/model selection**:
  - Provider: `Select` dropdown (OpenAI, Anthropic, Gemini, Ollama, Grok)
  - Model: `Select` dropdown from `aiChatState.modelsForProvider(currentProvider)` — curated per-provider list
  - When provider changes, auto-select first model for that provider

  **Input**: Textarea (Enter sends, Shift+Enter newline), send/stop button toggle

  **Part B — Wire into App.svelte**:
  - Add third `Tabs.Trigger value="ai"` with "AI" label + sparkle icon
  - Add `Tabs.Content value="ai"` with `<AiChat />`
  - AI tab OUTSIDE the `{#await browserState.whenReady}` block

  **Must NOT do**:
  - Do NOT add markdown rendering, code formatting, copy/edit/delete actions
  - Do NOT add conversation management buttons
  - Do NOT modify existing components or tab behavior

  **Recommended Agent Profile**:
  - **Category**: `visual-engineering`
  - **Skills**: [`svelte`, `styling`, `frontend-ui-ux`]

  **Parallelization**: Wave 3. Blocks Task 8.

  **References**:
  - `apps/tab-manager/src/entrypoints/sidepanel/App.svelte` — File to modify.
  - `apps/tab-manager/src/lib/components/SavedTabList.svelte` — Component pattern.
  - `@epicenter/ui/chat` — Bubble, BubbleAvatar, BubbleMessage, List.
  - `@epicenter/ui/select` — Root, Trigger, Content, Item.
  - `@epicenter/ui/empty` — Root, Media, Title, Description.

  **Acceptance Criteria**:

  ```
  Scenario: Extension builds
    Steps: bun run typecheck && bun run build in apps/tab-manager
    Expected Result: Both exit 0

  Scenario: Three tabs in App.svelte
    Steps: Count Tabs.Trigger elements, verify value="ai"
    Expected Result: 3 triggers, "ai" present
  ```

  **Commit**: YES — `feat(tab-manager): add AI chat tab with TanStack AI streaming`

- [ ] 7. Server: Add tests for env var API key fallback

  **What to do**:
  - Add tests to `packages/server/src/ai/plugin.test.ts`:
    1. `resolveApiKey()` returns header key when both present
    2. Returns env var key when header absent
    3. Returns undefined when neither present
    4. Updated 401 message mentions env var name
    5. Plugin accepts request without header when env var set
  - Update existing 401 test if error message changed

  **Must NOT do**: No actual provider API calls, no integration tests, no test infra changes.

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: [`typescript`]

  **Parallelization**: Wave 4 (with Task 8). Blocked by Task 1.

  **Acceptance Criteria**:

  ```
  Scenario: All server tests pass
    Steps: bun test in packages/server
    Expected Result: All pass
  ```

  **Commit**: YES — `test(server): add tests for env var API key fallback`

- [ ] 8. Extension: Build + typecheck verification

  **What to do**: Run `bun run typecheck` and `bun run build` in `apps/tab-manager/`. Fix any errors.

  **Must NOT do**: Do NOT modify source code unless fixing a genuine build error.

  **Recommended Agent Profile**:
  - **Category**: `quick`
  - **Skills**: [`monorepo`]

  **Parallelization**: Wave 4 (with Task 7). Blocked by Task 6.

  **Acceptance Criteria**:

  ```
  Scenario: Full build pipeline passes
    Steps: bun run typecheck && bun run build in apps/tab-manager
    Expected Result: Both exit 0
  ```

  **Commit**: NO (verification only)

---

## Final Verification Wave (MANDATORY — after ALL implementation tasks)

> 2 review agents run in PARALLEL. Both must APPROVE. Rejection → fix → re-run.

- [ ] F1. **Plan Compliance Audit** — `oracle`
      For each "Must Have": verify implementation exists. For each "Must NOT Have": search codebase for forbidden patterns — reject with file:line if found. Compare deliverables against plan.
      Output: `Must Have [N/N] | Must NOT Have [N/N] | Tasks [N/N] | VERDICT: APPROVE/REJECT`

- [ ] F2. **Code Quality Review** — `unspecified-high`
      Run typecheck + tests. Review changed files for: `as any`/`@ts-ignore`, empty catches, console.log in prod, commented-out code, unused imports. Check AI slop.
      Output: `Build [PASS/FAIL] | Tests [N pass/N fail] | Files [N clean/N issues] | VERDICT`

---

## Commit Strategy

- **T1**: `feat(server): add env var API key fallback for AI providers` — adapters.ts, plugin.ts
- **T2**: `build(tab-manager): add @tanstack/ai-svelte dependencies` — package.json, bun.lock
- **T3**: `feat(tab-manager): add configurable server URL settings` — settings.ts
- **T4**: `feat(tab-manager): add chatMessages table to workspace schema` — workspace.ts
- **T5**: `feat(tab-manager): add AI chat state module` — ai-chat-state.svelte.ts
- **T6**: `feat(tab-manager): add AI chat tab with TanStack AI streaming` — AiChat.svelte, App.svelte
- **T7**: `test(server): add tests for env var API key fallback` — plugin.test.ts

---

## Success Criteria

### Verification Commands

```bash
# Server tests pass
cd packages/server && bun test

# Extension typechecks
cd apps/tab-manager && bun run typecheck

# Extension builds
cd apps/tab-manager && bun run build

# Server env var API key works
OPENAI_API_KEY=sk-test bun packages/server/src/start.ts &
curl -s -X POST http://localhost:3913/ai/chat \
  -H 'Content-Type: application/json' \
  -d '{"messages":[{"role":"user","content":[{"type":"text","content":"say hi"}]}],"provider":"openai","model":"gpt-4o-mini"}' \
  | head -3  # Expected: NOT 401
```

### Final Checklist

- [ ] All "Must Have" items present and verified
- [ ] All "Must NOT Have" items absent
- [ ] All tests pass (server + extension typecheck + build)
- [ ] Three tabs visible in sidepanel (Tabs, Saved, AI)
- [ ] Chat messages stream via SSE
- [ ] Provider dropdown functional
- [ ] Model dropdown functional (curated per provider)
- [ ] Error states handled gracefully
- [ ] Messages persist in Y.Doc across panel reopens
